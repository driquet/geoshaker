{% extends "base.html" %}
{% import "forms.html" as m %}

{% block content %}
    <p class="lead">While solving mystery cache, Geoshaker gives you a hand by shaking all combinations and keeping the coherent ones. Give it a try !</p>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-danger alert-dismissable">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}
    {% endwith %}


    <form class="form-horizontal well" role="form" method="post">

        <fieldset>
            <legend>Coordinates to shake</legend>
            <p>
            <em>
                Please enter here the initial coordinates of the mystery cache and
                the coordinates of the cache which can contain symbols (a symbol is a lowercase letter).
            </em>
            </p>
            {{ m.form_field_label(form.mystery, "test") }}
            {{ m.form_field_label(form.cache) }}
            {{ m.form_field_label(form.max_distance, size=2) }}
        </fieldset>

        <fieldset>
            <legend>Unknown values</legend>
            <p>
            <em>
                An unknown value is a variable. It has a name (or a symbol) and a range (from min to max value).
                You can use up to 6 variables.
            </em>
            </p>
            <div class="form-group">
                <p class="col-sm-offset-4 col-sm-2 text-center"><strong>Symbol</strong></p>
                <p class="col-sm-2 text-center"><strong>Min value</strong></p>
                <p class="col-sm-2 text-center"><strong>Max value</strong></p>
            </div>

            {% for var in form.variables %}
                {{ m.form_variable(var, loop.index) }}
            {% endfor %}

            <p class="col-sm-offset-8">
                <button type="button" class="btn btn-default btn-sm" id="add_variable">
                <span class="glyphicon glyphicon-plus"></span> Add a variable
                </button>
            </p>

        </fieldset>

        <fieldset id="marker_fs">
            <legend>Custom markers</legend>
            <p>
            <em>
                You can add custom markers on the map. You can draw a circle around this marker (default is 161 meters, hehe).
                Also, you can exclude combinations from shaked combinations if the result is too close from your marker.
                Useful, eh !
            </em>
            </p>

            <div class="{% if not form.customs|length %}hide{% endif %}">
                <p class="col-sm-3 text-center"><strong>Name</strong></p>
                <p class="col-sm-4 text-center"><strong>Coordinates</strong></p>
                <p class="col-sm-2 text-center"><strong>Radius</strong></p>
                <p class="col-sm-1 text-center"><strong>Circle</strong></p>
                <p class="col-sm-1 text-center"><strong>Exclude</strong></p>
            </div>

            {% for custom in form.customs %}
                {{ m.form_custom(custom, loop.index0) }}
            {% endfor %}

            <p class="col-sm-offset-8">
                <button type="button" class="btn btn-default btn-sm" id="add_marker">
                <span class="glyphicon glyphicon-plus"></span> Add a marker
                </button>
            </p>



        </fieldset>


        <hr/>
        <div class="alert alert-info hide" id="loading-div">
            <p class="text-center">
            <small>
                Computing all the combination can be long. Please do not refresh the page, it will not make it quicker !
            </small>
            </p>
        </div>

        <button type="submit" id="form_button" class="btn btn-default col-sm-offset-10">Submit</button>

    </form>
{% endblock %}

{% block js_include %}

<script>
    $(document).ready(function () {
        $('#add_variable').click(function () {
            clone_variable('.unknowns:last');
        });

        $('#form_button').click(function () {
            $('#loading-div').removeClass('hide');
        });

        $('#add_marker').click(function () {
            clone_marker();
        });


    });

    function clone_marker() {
        var marker_fs = $('#marker_fs');
        var header_fs = marker_fs.find('div:first');
        var marker_nb = marker_fs.find('div.form-group').length;
        var new_marker = $('{{ m.new_custom()|replace("\n","") }}');

        // Toggle header
        if (header_fs.hasClass('hide')) {
            header_fs.removeClass('hide');
        }

        // Replace i with corresponding index
        new_marker.find('label:first').text((marker_nb + 1));
        new_marker.find(':input').each(function() {
            var id = $(this).attr('id').replace('-i-', '-' + marker_nb + '-');
            $(this).attr({'name': id, 'id': id});
        });
        new_marker.find('a:last').attr('onclick', 'remove_custom(' + marker_nb + ');')

        // Insert new marker
        if (marker_nb == 0) {
            header_fs.after(new_marker);
        } else {
            marker_fs.find('div.form-group:last').after(new_marker);
        }
    }

    function remove_custom(idx) {
        var marker_fs = $('#marker_fs');
        var header_fs = marker_fs.find('div:first');
        var markers = marker_fs.find('div.form-group');

        // Toggle header if necessary
        if (markers.length == 1) {
            header_fs.addClass('hide');
        }

        // Update following markers
        for (var i = idx + 1; i < markers.length; i++) {
            var marker = $(markers[i]);
            marker.find(':input').each(function() {
                var id = $(this).attr('id').replace('-' + i + '-', '-' + (i - 1) + '-');
                $(this).attr({'name': id, 'id': id});
            });
            marker.find('a:last').attr('onclick', 'remove_custom(' + (i - 1) + ');')
        }

        // Remove corresponding marker
        markers[idx].remove();


    }

    function clone_variable(selector) {
        var new_element = $(selector).clone(true);
        var elem_id = new_element.find(':input')[0].id;
        var elem_num = parseInt(elem_id.replace(/.*-(\d{1,4})-.*/m, '$1')) + 1;
        if (elem_num < 6) {
            new_element.find(':input').each(function() {
                var id = $(this).attr('id').replace('-' + (elem_num - 1) + '-', '-' + elem_num + '-');
                $(this).attr({'name': id, 'id': id}).val('').removeAttr('checked');
            });
            new_element.find('label').each(function() {
                var new_for = $(this).attr('for').replace('-' + (elem_num - 1) + '-', '-' + elem_num + '-');
                $(this).attr('for', new_for);
            });
            new_element.find('label:first').text('Variable ' + (elem_num + 1));
            $(selector).after(new_element);

            if (elem_num == 5) {
                $('#add_another_button').attr("disabled", true);
            }
        }
    }

</script>

{% endblock %}
